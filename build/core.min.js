!function(){"use strict";function t(){}const e=document.getElementById.bind(document),i=(document.getElementsByClassName.bind(document),document.getElementsByTagName.bind(document),URL?t=>new URL(t,document.location).href:function(t){const e=document.createElement("a");return e.href=t,e.href}),n="loading"===document.readyState?(t=>new Promise(e=>addEventListener(t,e)))("DOMContentLoaded"):Promise.resolve(),s=(t,e)=>Math.floor(Math.random()*Math.floor(e))+t,r=Object.create(null);function o(t="config.js"){return(t=i(t))in r?Promise.resolve(r[t]):new Promise(function(e,i){const n=document.createElement("script");n.onload=function(){e(r[n.src]),n.remove()},n.onerror=function(){i(),n.remove()},document.head.appendChild(n),n.src=t})}function a(t,e,i){this.x=t,this.y=e,this.z=i}window.config=function(t){r[document.currentScript.src]=Object.freeze(t)},a.prototype.dot2=function(t,e){return this.x*t+this.y*e},a.prototype.dot3=function(t,e,i){return this.x*t+this.y*e+this.z*i};var h=[new a(1,1,0),new a(-1,1,0),new a(1,-1,0),new a(-1,-1,0),new a(1,0,1),new a(-1,0,1),new a(1,0,-1),new a(-1,0,-1),new a(0,1,1),new a(0,-1,1),new a(0,1,-1),new a(0,-1,-1)],c=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],l=new Array(512),u=new Array(512);function d(t){t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8);for(var e=0;e<256;e++){var i;i=1&e?c[e]^255&t:c[e]^t>>8&255,l[e]=l[e+256]=i,u[e]=u[e+256]=h[i%12]}}d(0);var p=.5*(Math.sqrt(3)-1),f=(3-Math.sqrt(3))/6;function m(t,e){var i,n,s=(t+e)*p,r=Math.floor(t+s),o=Math.floor(e+s),a=(r+o)*f,h=t-r+a,c=e-o+a;h>c?(i=1,n=0):(i=0,n=1);var d=h-i+f,m=c-n+f,E=h-1+2*f,w=c-1+2*f,g=u[(r&=255)+l[o&=255]],y=u[r+i+l[o+n]],k=u[r+1+l[o+1]],x=.5-h*h-c*c,v=.5-d*d-m*m,T=.5-E*E-w*w;return 70*((x<0?0:(x*=x)*x*g.dot2(h,c))+(v<0?0:(v*=v)*v*y.dot2(d,m))+(T<0?0:(T*=T)*T*k.dot2(E,w)))}const E="img/simple/",w={tile_width:64,tile_depth:32,block_height:16,player_height:128,tile_gap:2,tile_gap_z:1,noise_amplifier:1},g=["south","east","north","west"],y=g.map(t=>"player_"+t),k=["floor","block","mark","cuboid"],x={},v=Object.create(null);let T,L,S,b,R,O,A,M,C,I=!0,N=!0;function P(t=!0){I=t}function _(t=!0){N=t}async function H(){await Promise.all([async function(t){const e=t.tile_theme+"/",i=(t.player_theme||t.tile_theme)+"/",[n,s,r]=await Promise.all([e+"theme.js",i+"theme.js",E+"theme.js"].map(o)),a=Object.assign({},w,n);T=a.tile_width,L=a.tile_depth,S=a.block_height,b=a.tile_gap,R=a.tile_gap_z,O=a.noise_amplifier,A=s.player_height||a.player_height;for(const t of y)s.sprites.hasOwnProperty(t)?x[t]=U(t,s,i):n.sprites.hasOwnProperty(t)?x[t]=U(t,n,e):x[t]=U(t,r,E);for(const t of k)n.sprites.hasOwnProperty(t)?x[t]=U(t,n,e):x[t]=U(t,r,E);return Promise.all(Object.values(x).map(t=>t.load()))}(await o()),async function(){await n,M=document.getElementById("world-canvas"),(C=M.getContext("2d")).mozImageSmoothingEnabled=!1,C.webkitImageSmoothingEnabled=!1,C.msImageSmoothingEnabled=!1,C.imageSmoothingEnabled=!1}()])}function U(t,e,i){let n,s;try{[n,...s]=e.images[e.sprites[t]]}catch(e){return void console.warn(`Bad theme config: No image for sprite '${t}' in ${i}`)}return s.length?new q(i+n,...s):new B(i+n)}class B{constructor(t){this.imagePath=t}async load(){this._image=await D(this.imagePath);const t=T/this._image.width;this._scaledWidth=T,this._scaledHeight=t*this._image.height,this.height=this._scaledHeight-L}draw(t,e,i){t.drawImage(this._image,e,i-this.height,this._scaledWidth,this._scaledHeight)}}class q{constructor(t,e,i,n,s,r=0,o=0){this.imagePath=t,this._crop={x:e,y:i,width:n,height:s};const a=T/n;this._scaledWidth=T,this._scaledHeight=a*s,this.height=this._scaledHeight-L,this.xOffset=r,this.yOffset=o}async load(){this._image=await D(this.imagePath)}draw(t,e,i){t.drawImage(this._image,this._crop.x,this._crop.y,this._crop.width,this._crop.height,e+this.xOffset,i-this.height-this.yOffset,this._scaledWidth,this._scaledHeight)}}function D(t){return t in v?v[t]:v[t]=new Promise(function(e){const i=new Image;i.onload=function(){e(i)},i.src=t})}class j{constructor(t,e,i,n,r,o){this.width=t,this.length=e,this.height=i,this.seed=n||s(1<<31,-(1<<31)),this.player=r||{x:0,y:0,orientation:0},this.tiles=o||Array.from({length:t*e},()=>({blocks:0,mark:!1}))}static move({x:t,y:e,orientation:i},n=1,s=0){switch(i){case 0:t+=s,e+=n;break;case 1:t+=n,e+=s;break;case 2:t-=s,e-=n;break;case 3:t-=n,e-=s}return[t,e]}contains(t,e){return t>=0&&e>=0&&t<this.width&&e<this.length}isLookingAtEdge(){return!this.contains(...j.move(this.player))}step(t=1,e=0){const i=this.tiles[this.player.x*this.length+this.player.y].blocks,[n,s]=j.move(this.player,t,e);if(!this.contains(n,s))throw new Error("invalid move: out of world");const r=this.tiles[n*this.length+s];if(1<Math.abs(i-r.blocks))throw new Error("invalid move: jump too high");if(r.cuboid)throw new Error("invalid move: cuboid");[this.player.x,this.player.y]=[n,s]}stepBackwards(){this.step(-1)}turnLeft(){this.player.orientation=(this.player.orientation+1)%4}turnRight(){this.player.orientation=(this.player.orientation+3)%4}placeBlock(){const[t,e]=j.move(this.player);if(!this.contains(t,e))throw new Error("invalid action: out of world");const i=this.tiles[t*this.length+e];if(i.cuboid)throw new Error("invalid action: block on cuboid");if(i.blocks>=this.height)throw new Error("invalid action: building too high");i.blocks++}takeBlock(){const[t,e]=j.move(this.player);if(!this.contains(t,e))throw new Error("invalid action: out of world");const i=this.tiles[t*this.length+e];if(i.blocks<=0)throw new Error("invalid action: no blocks");i.blocks--}placeMark(){const t=this.tiles[this.player.x*this.length+this.player.y];if(t.mark)throw new Error("invalid action: already has a mark");t.mark=!0}takeMark(){const t=this.tiles[this.player.x*this.length+this.player.y];if(!t.mark)throw new Error("invalid action: no mark");t.mark=!1}}const G=10,W="IDENTIFIER",z="INTEGER",Q="NOT",$="IF",F="THEN",K="ELSE",Y="WHILE",Z="DO",J="REPEAT",V="TIMES",X="PROGRAM",tt="ROUTINE",et="LPAREN",it="RPAREN",nt="ASTERISC",st="WHITESPACE",rt="COMMENT",ot="EOF",at=Object.freeze({IDENTIFIER:W,INTEGER:z,NOT:Q,IF:$,THEN:F,ELSE:K,WHILE:Y,DO:Z,REPEAT:J,TIMES:V,PROGRAM:X,ROUTINE:tt,LPAREN:et,RPAREN:it,LBRACKET:"LBRACKET",RBRACKET:"RBRACKET",LBRACE:"LBRACE",RBRACE:"RBRACE",LESS:"LESS",GREATER:"GREATER",EQUALS:"EQUALS",ASTERISC:nt,SLASH:"SLASH",HYPHENMINUS:"HYPHENMINUS",PLUS:"PLUS",DOT:"DOT",COMMA:"COMMA",COLON:"COLON",SEMI:"SEMI",SINGLEQUOTE:"SINGLEQUOTE",DOUBLEQUOTE:"DOUBLEQUOTE",WHITESPACE:st,COMMENT:rt,EOF:ot});class ht{constructor(t,e,i,n){this.type=t,this.value=e,this.line=i,this.column=n}toString(){return this.type+"("+this.value+")"}}const ct={wenn:$,if:$,dann:F,then:F,sonst:K,else:K,solange:Y,while:Y,tue:Z,do:Z,nicht:Q,not:Q,wiederhole:J,repeat:J,mal:V,times:V,programm:X,program:X,anweisung:tt,routine:tt},lt={"(":et,")":it,"[":"LBRACKET","]":"RBRACKET","{":"LBRACE","}":"RBRACE","<":"LESS",">":"GREATER","=":"EQUALS","*":nt,"/":"SLASH","-":"HYPHENMINUS","+":"PLUS",".":"DOT",",":"COMMA",":":"COLON",";":"SEMI","'":"SINGLEQUOTE",'"':"DOUBLEQUOTE"},ut=new Set(Object.keys(lt)),dt=/\s/,pt=/[0-9]/,ft=/[A-Za-z0-9_]/i;class mt{constructor(t,e=!1,i=!1){this.text=t,this.yieldWhitespace=e,this.yieldComments=i,this.position=0,this.line=1,this.column=1,this.eof=!1}[Symbol.iterator](){return this}next(){const t=this.nextToken();return t.type===ot?{done:!0}:{value:t,done:!1}}nextToken(){let t,e;do{const{column:i,line:n}=this;for(e=this.position,t="";this.position<this.text.length&&dt.test(this.text[this.position]);)t+=this.text[this.position],"\n"===this.text[this.position]&&(this.column=0,this.line++),this.position++,this.column++;if(t.length){if(this.yieldWhitespace)return new ht(st,t,n,i)}else if((t=this.text[this.position])+this.text[e+1]!=="//"){if("{"!==t);else if(this.position=this.text.indexOf("}",e)+1,this.position<e&&(this.position=this.text.length),this.column+=this.position-e,this.yieldComments)return new ht(rt,this.text.slice(e,this.position),n,i)}else if(this.position=this.text.indexOf("\n",e),this.column+=this.position-e,this.yieldComments)return new ht(rt,this.text.slice(e,this.position),n,i)}while(e<this.position);const{column:i,line:n}=this;if(t=this.text[this.position],ut.has(t))return this.position++,this.column++,new ht(lt[t],t,n,i);if((t=this.readWhile(pt)).length)return new ht(z,+t,n,i);if((t=this.readWhile(ft)).length)return new ht(ct[t.toLowerCase()]||W,t,n,i);if(this.position>=this.text.length)return new ht(ot,"",n,i);throw new Error(`Syntax Error: Could not read next token in line ${n} column ${i}.`)}readWhile(t){let e="";for(;this.position<this.text.length&&t.test(this.text[this.position]);)e+=this.text[this.position],this.position++,this.column++;return e}get remainingText(){return this.text.slice(this.position)}}class Et{constructor(t){this.tokens=t,this.depth=0,this.forward()}forward(){this.currentToken=this.tokens.nextToken()}eat(t){if(this.currentToken.type!==t)throw new Error("Syntax Error on line "+this.tokens.line+": Unexpected token "+this.currentToken+", was expecting "+t+".");this.forward()}readToken(...t){if(t.includes(this.currentToken.type)){const t=this.currentToken.value;return this.forward(),t}throw new Error("Syntax Error on line "+this.tokens.line+": Unexpected token "+this.currentToken+". Expected any of "+t)}readExpression(){switch(this.currentToken.type){case W:return this.readCall();case z:{const t=+this.currentToken.value;return this.forward(),{type:z,value:t}}case Q:return this.forward(),{type:Q,expression:this.readExpression()};case et:{const t=this.readExpression();return this.eat(it),t}}}readCall(){const t={type:W,identifier:this.currentToken.value,line:this.currentToken.line};return this.forward(),this.currentToken.type===et&&(this.forward(),this.currentToken.type===it?this.forward():(t.argument=this.readExpression(),this.eat(it))),t}readSequence(){const t=[],e=[nt,K,ot];for(this.depth++;!e.includes(this.currentToken.type);)t.push(this.readStatement());return this.depth--,t}readStatement(){const t={type:this.currentToken.type};switch(this.currentToken.type){case W:return this.readCall();case $:return this.forward(),t.condition=this.readExpression(),this.eat(F),t.sequence=this.readSequence(),this.currentToken.type===K&&(this.forward(),t.alternative=this.readSequence()),this.eat(nt),this.eat($),t;case Y:return this.forward(),t.condition=this.readExpression(),this.eat(Z),t.sequence=this.readSequence(),this.eat(nt),this.eat(Y),t;case J:return this.forward(),this.currentToken.type===Y?(t.type=Y,this.forward(),t.condition=this.readExpression()):(t.count=this.readExpression(),this.eat(V)),t.sequence=this.readSequence(),this.eat(nt),this.eat(J),t;case X:if(this.depth>1)throw new Error("Parse Error on line "+this.tokens.line+": Can't define program in nested context.");return this.forward(),t.sequence=this.readSequence(),this.eat(nt),this.eat(X),t;case tt:if(this.depth>1)throw new Error("Parse Error on line "+this.tokens.line+": Can't define routine in nested context.");return this.forward(),t.identifier=this.readToken(W),t.sequence=this.readSequence(),this.eat(nt),this.eat(tt),t}throw new Error("Parse Error on line "+this.tokens.line+": Unexpected token "+this.currentToken+".")}}const wt={linksdrehen:"turnLeft",rechtsdrehen:"turnRight",schritt:"step","schrittzurück":"stepBackwards",hinlegen:"placeBlock",aufheben:"takeBlock",markesetzen:"placeMark","markelöschen":"takeMark",istwand:"isLookingAtEdge"},gt=new class{constructor(t){this.runtime=t,this.routines=Object.create(null)}interrupt(){this._interrupted=!0}async run(t){const e=new mt(t),i=new Et(e).readSequence();this._interrupted=!1,await this.visitSequence(i)}async visitSequence(t){for(const e of t)await this.visitStatement(e)}async visitStatement(t){switch(t.type){case W:if(this._interrupted)return;if(t.identifier in this.routines){if(this.depth>G)throw new Error("RunTime Error: Maximum recursion depth ("+G+") exceeded.");await this.visitSequence(this.routines[t.identifier])}else await this.runtime.execute(t.identifier,t.line);break;case $:await this.visitExpression(t.condition)?await this.visitSequence(t.sequence):t.alternative&&await this.visitSequence(t.alternative);break;case Y:for(;await this.visitExpression(t.condition);)await this.visitSequence(t.sequence);break;case J:{const e=await this.visitExpression(t.count);for(let i=0;i<e;i++)await this.visitSequence(t.sequence);break}case X:await this.visitSequence(t.sequence);break;case tt:this.routines[t.identifier]=t.sequence;break;default:throw new Error(`Unimplemented statement type ${t.type}`)}}async visitExpression(t){switch(t.type){case z:return+t.value;case W:return this.runtime.evaluate(t.identifier);case Q:return!await this.visitExpression(t.expression);default:throw new Error("Unimplemented expression type")}}}({execute:async function(t,e=null){if(await Lt,!vt)return;Rt(t,e),Pt(t),Mt(),xt&&await Ot(kt)},evaluate:Pt});let yt,kt=100,xt=!0,vt=!1,Tt=!1,Lt=Promise.resolve(),St=t,bt=t,Rt=t;const Ot=t=>new Promise(function(e){bt=e,setTimeout(e,t)});function At(t){yt=t,Mt()}function Mt(){!function({width:t,length:e,height:i,player:n,tiles:s,seed:r}){let o=.5*(t+e)*(T+2*b),a=.5*(t+e)*(L+1*b)+i*S+A;M.width!==o&&(M.width=o),M.height!==a&&(M.height=a),C.clearRect(0,0,M.width,M.height),N&&d(r);const h=.5*(e-1)*(T+2*b);let c,l,u;for(let r=0;r<t;++r)for(let t=0;t<e;++t){c=.5*(-t+r)*(T+2*b)+b+h,l=.5*(t+r)*(L+1*b)-.5*b+i*S+A;const o=s[r*e+t];if(u=0,N&&(u+=5*O*m(r/10,t/10)+O*m(r/3,t/3)),x.floor.draw(C,c,l-u),u+=x.floor.height+R,o.cuboid)x.cuboid.draw(C,c,l-u),u+=x.cuboid.height+R;else{for(let t=0;t<o.blocks;++t)x.block.draw(C,c,l-u),u+=x.block.height+R;o.mark&&(x.mark.draw(C,c,l-u),u+=x.mark.height+R)}I&&n.x===r&&n.y===t&&x["player_"+g[n.orientation]].draw(C,c,l-u)}}(yt)}function Ct(t){kt=t}function It(){Tt||(Tt=!0,Lt=new Promise(t=>St=t))}function Nt(){Tt&&(Tt=!1,bt(),St())}function Pt(t){const e=wt[t.toLowerCase()];if(!e)throw new Error(`RunTime Error: ${t} is not defined.`);return yt[e]()}const _t=Object.create(null);_t[at.IDENTIFIER]="identifier",_t[at.INTEGER]="number",_t[at.COMMENT]="comment",[at.NOT,at.IF,at.THEN,at.ELSE,at.WHILE,at.DO,at.REPEAT,at.TIMES,at.PROGRAM,at.ROUTINE].forEach(t=>_t[t]="keyword"),[at.LPAREN,at.RPAREN,at.LBRACKET,at.RBRACKET,at.LBRACE,at.RBRACE,at.LESS,at.GREATER,at.EQUALS,at.ASTERISC,at.SLASH,at.HYPHENMINUS,at.PLUS,at.DOT,at.COMMA,at.COLON,at.SEMI,at.SINGLEQUOTE,at.DOUBLEQUOTE].forEach(t=>_t[t]="punctuation");function Ht(t){return function(t){return new Promise(function(e){const i=new FileReader;i.onload=function(){e(i.result)},i.readAsText(t)})}(t).then(Ut)}function Ut(t){const e=t.split(/\s+/),[i,n,s,r,o,a]=e.slice(1,7).map(t=>+t),h=[];for(let t=0;t<i*n;t++){const i=7+(s+1)*t,n=e.slice(i,i+s+1),r={blocks:n.filter(t=>"z"===t).length,mark:"m"===n[n.length-1]};n.includes("q")&&(r.cuboid=!0),h.push(r)}return new j(i,n,s,0,{x:r,y:o,orientation:a},h)}const Bt={ArrowLeft:"LinksDrehen",a:"LinksDrehen",ArrowRight:"RechtsDrehen",d:"RechtsDrehen",ArrowUp:"Schritt",w:"Schritt",ArrowDown:"SchrittZurück",s:"SchrittZurück",h:"Hinlegen",H:"Aufheben",m:"MarkeSetzen",M:"MarkeLöschen"};let qt,Dt,jt,Gt,Wt,zt;function Qt(){var t,e,i;t=+Dt.value,e=+jt.value,i=+Gt.value,At(new j(t,e,i))}function $t(){Ht(Wt.files[0]).then(At)}function Ft(t,e,i){e.addEventListener(t,function(t){t.preventDefault(),i.apply(this,arguments)})}function Kt(...t){t.map(t=>t.removeAttribute("disabled"))}function Yt(...t){t.map(t=>t.setAttribute("disabled","disabled"))}function Zt(){Dt=e("width-input"),jt=e("length-input"),Gt=e("height-input"),Wt=e("file-input"),zt=e("status-text");const t=e("world-simulation-speed"),i=e("world-show-player"),n=e("world-show-flat");Ft("submit",e("world-create-form"),Qt),Ft("submit",e("world-load-form"),$t),Ft("change",Wt,$t),Ft("change",i,function(){P(i.checked),Mt()}),P(i.checked),Ft("change",n,function(){_(!n.checked),Mt()}),_(!n.checked),Ft("change",t,function(){Ct(Math.pow(10,4-t.value))}),Ct(Math.pow(10,4-t.value)),Qt(),addEventListener("keydown",async function(t){if(t.defaultPrevented||t.target instanceof HTMLTextAreaElement)return;const e=Bt[t.key];if(e){if(t.preventDefault(),vt)return;try{await(i=e,Pt(i),void Mt()),zt.innerHTML="",zt.classList.remove("status-error")}catch(t){zt.innerHTML=t.message,zt.classList.add("status-error")}}var i})}function Jt(){const t=e("run-button"),i=e("stop-button"),n=e("step-button"),s=e("unpause-button"),r=e("pause-button");Yt(i,n,r,s),Ft("click",t,async function(){Yt(t),Kt(i,n,r),zt.innerHTML="",zt.classList.remove("status-error"),zt.innerHTML="RUNNING.";try{await async function(t){xt=!0,vt=!0,Nt(),await gt.run(t)}(qt.value)}catch(t){zt.innerHTML=t.message,zt.classList.add("status-error")}finally{Kt(t),Yt(i,n,r,s),qt.markLine()}}),Ft("click",i,function(){gt.interrupt(),vt=!1,xt=!1,Nt(),zt.innerHTML="STOPPED."}),Ft("click",n,function(){!async function(){if(vt)if(Tt){const t=xt;xt=!1,Nt(),await Lt,It(),xt=t}else bt()}()}),Ft("click",r,function(){It(),zt.innerHTML="PAUSED.",Yt(r),Kt(s)}),Ft("click",s,function(){Nt(),zt.innerHTML="RUNNING.",Yt(s),Kt(r)})}!async function(){const t=(await o()).editor_theme||"bright";e("editor-theme-stylesheet").href=`css/editor-theme-${t}.css`,await Promise.all([H(),n]),qt=new class{constructor(t,e="    "){this.indentation=e,this.unindenRegex=new RegExp("^"+e.split("").join("?")+"?","gm"),this.scrollbox=t.getElementsByClassName("editor-scrollbox")[0],this.highlighted=t.getElementsByClassName("editor-highlight")[0];const i=this.textarea=t.getElementsByClassName("editor-textarea")[0],n=this.caretLayer=t.getElementsByClassName("editor-caret-layer")[0];this.beforeCaret=n.appendChild(document.createElement("span")),this.caret=n.appendChild(document.createElement("span")),this.caret.classList.add("editor-caret"),this.selection=n.appendChild(document.createElement("span")),this.selection.classList.add("editor-selection"),i.addEventListener("keydown",t=>{"Tab"!==t.key&&9!==t.keyCode||(t.preventDefault(),t.shiftKey?this.unindent():this.indent())}),i.addEventListener("input",this.update.bind(this));const s=this.updateCaret.bind(this),r=()=>setTimeout(s,0);i.addEventListener("keypress",r),i.addEventListener("keydown",r),i.addEventListener("mousedown",function(){this.addEventListener("mousemove",r),r()}),i.addEventListener("mouseup",function(){this.removeEventListener("mousemove",r),r()}),this.update()}get value(){return this.textarea.value}set value(t){this.textarea.value=t,this.update()}update(){this.highlighted.innerHTML=function(t){let e="",i=1;const n=()=>`</span></span><span class="line"><span class="lineno">${++i}</span><span>`,s=new mt(t,!0,!0);try{for(const t of s)t.type in _t?e+=`<span class="token ${_t[t.type]}">${t.value}</span>`:e+=t.value.replace(/ /g,"·").replace(/\n/g,n)}catch(t){e+=s.remainingText.replace(/\n/g,n)}return`<span class="line"><span class="lineno">1</span><span>${e}</span></span>`}(this.textarea.value),this.textarea.style.height=this.highlighted.offsetHeight+"px",this.updateCaret()}updateCaret(){const{value:t,selectionDirection:e,selectionEnd:i,selectionStart:n}=this.textarea;this.beforeCaret.innerHTML=t.slice(0,n),this.selection.innerHTML=t.slice(n,i),this.caret.insertAdjacentElement("forward"===e?"beforebegin":"afterend",this.selection),this.caret.classList.remove("blink"),requestAnimationFrame(()=>this.caret.classList.add("blink"))}markLine(t){for(const t of this.highlighted.getElementsByClassName("current"))t.classList.remove("current");const e=this.highlighted.children[t-1];e&&e.classList.add("current")}indent(){const{value:t,selectionStart:e,selectionEnd:i,selectionDirection:n}=this.textarea;if(t.slice(e,i).includes("\n")){const s=t.lastIndexOf("\n",e-1)+1;let r=t.indexOf("\n",i);r<0&&(r=t.length);const o=t.slice(s,r).replace(/^/gm,this.indentation);this.textarea.value=t.slice(0,s)+o+t.slice(r),this.textarea.selectionStart=e+this.indentation.length,this.textarea.selectionEnd=s+o.length-(r-i),this.textarea.selectionDirection=n}else{let n=this.indentation;if("\t"!==n){const i=t.lastIndexOf("\n",e)+1,s=n.length-(e-i)%n.length;n=n.substr(0,s)}this.textarea.value=t.slice(0,e)+n+t.slice(i),this.textarea.selectionStart=this.textarea.selectionEnd=e+n.length}this.update()}unindent(){const{value:t,selectionStart:e,selectionEnd:i,selectionDirection:n}=this.textarea,s=t.lastIndexOf("\n",e-1)+1;let r=t.indexOf("\n",i);r<0&&(r=t.length);let o=null;const a=t.slice(s,r).replace(this.unindenRegex,function(t){return null===o&&(o=t.length),""});this.textarea.value=t.slice(0,s)+a+t.slice(r),this.textarea.selectionStart=Math.max(s,e-o),this.textarea.selectionEnd=Math.max(s+a.lastIndexOf("\n")+1,i-r+s+a.length),this.textarea.selectionDirection=n,this.update()}}(e("editor")),Rt=((t,e)=>qt.markLine(e)),Zt(),Jt(),qt.value=await fetch("BOT.kdp").then(t=>t.text())}()}();
