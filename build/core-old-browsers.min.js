!function(){"use strict";var e,t=(function(e){!function(t){var n,r=Object.prototype,i=r.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",u=a.toStringTag||"@@toStringTag",c=t.regeneratorRuntime;if(c)e.exports=c;else{(c=t.regeneratorRuntime=e.exports).wrap=g;var h="suspendedStart",l="suspendedYield",f="executing",d="completed",p={},v={};v[o]=function(){return this};var y=Object.getPrototypeOf,m=y&&y(y(O([])));m&&m!==r&&i.call(m,o)&&(v=m);var w=b.prototype=k.prototype=Object.create(v);x.prototype=w.constructor=b,b.constructor=x,b[u]=x.displayName="GeneratorFunction",c.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===x||"GeneratorFunction"===(t.displayName||t.name))},c.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,u in e||(e[u]="GeneratorFunction")),e.prototype=Object.create(w),e},c.awrap=function(e){return{__await:e}},T(R.prototype),R.prototype[s]=function(){return this},c.AsyncIterator=R,c.async=function(e,t,n,r){var i=new R(g(e,t,n,r));return c.isGeneratorFunction(t)?i:i.next().then(function(e){return e.done?e.value:i.next()})},T(w),w[u]="Generator",w[o]=function(){return this},w.toString=function(){return"[object Generator]"},c.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},c.values=O,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(I),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=n)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,i){return s.type="throw",s.arg=e,t.next=r,i&&(t.method="next",t.arg=n),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],s=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var u=i.call(o,"catchLoc"),c=i.call(o,"finallyLoc");if(u&&c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,p):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),I(n),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;I(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=n),p}}}function g(e,t,n,r){var i=t&&t.prototype instanceof k?t:k,a=Object.create(i.prototype),o=new A(r||[]);return a._invoke=function(e,t,n){var r=h;return function(i,a){if(r===f)throw new Error("Generator is already running");if(r===d){if("throw"===i)throw a;return N()}for(n.method=i,n.arg=a;;){var o=n.delegate;if(o){var s=L(o,n);if(s){if(s===p)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===h)throw r=d,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=f;var u=E(e,t,n);if("normal"===u.type){if(r=n.done?d:l,u.arg===p)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r=d,n.method="throw",n.arg=u.arg)}}}(e,n,o),a}function E(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}function k(){}function x(){}function b(){}function T(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function R(e){var t;this._invoke=function(n,r){function a(){return new Promise(function(t,a){!function t(n,r,a,o){var s=E(e[n],e,r);if("throw"!==s.type){var u=s.arg,c=u.value;return c&&"object"==typeof c&&i.call(c,"__await")?Promise.resolve(c.__await).then(function(e){t("next",e,a,o)},function(e){t("throw",e,a,o)}):Promise.resolve(c).then(function(e){u.value=e,a(u)},o)}o(s.arg)}(n,r,t,a)})}return t=t?t.then(a,a):a()}}function L(e,t){var r=e.iterator[t.method];if(r===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=n,L(e,t),"throw"===t.method))return p;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var i=E(r,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,p;var a=i.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=n),t.delegate=null,p):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,p)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function I(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function O(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,a=function t(){for(;++r<e.length;)if(i.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=n,t.done=!0,t};return a.next=a}}return{next:N}}function N(){return{value:n,done:!0}}}(function(){return this}()||Function("return this")())}(e={exports:{}},e.exports),e.exports),n=function(){return this}()||Function("return this")(),r=n.regeneratorRuntime&&Object.getOwnPropertyNames(n).indexOf("regeneratorRuntime")>=0,i=r&&n.regeneratorRuntime;n.regeneratorRuntime=void 0;var a=t;if(r)n.regeneratorRuntime=i;else try{delete n.regeneratorRuntime}catch(e){n.regeneratorRuntime=void 0}var o=a,s=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function r(i,a){try{var o=t[i](a),s=o.value}catch(e){return void n(e)}if(!o.done)return Promise.resolve(s).then(function(e){r("next",e)},function(e){r("throw",e)});e(s)}("next")})}},u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),h=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{!r&&s.return&&s.return()}finally{if(i)throw a}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(e){return Array.isArray(e)?e:Array.from(e)},f=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},d=document.getElementById.bind(document),p=document.getElementsByClassName.bind(document),v=(document.getElementsByTagName.bind(document),URL?function(e){return new URL(e,document.location).href}:function(e){var t=document.createElement("a");return t.href=e,t.href}),y=function(e,t){return Math.floor(Math.random()*Math.floor(t))+e},m=(function(){function e(t){u(this,e),this._seed=t%2147483647,this._seed<=0&&(this._seed+=2147483646)}c(e,[{key:"next",value:function(){return this._seed=16807*this._seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}])}(),Object.create(null));function w(e){return(e=v(e))in m?Promise.resolve(m[e]):new Promise(function(t,n){var r=document.createElement("script");r.onload=function(){t(m[r.src]),r.remove()},r.onerror=function(){n(),r.remove()},document.head.appendChild(r),r.src=e})}function g(e,t,n){this.x=e,this.y=t,this.z=n}window.config=function(e){m[document.currentScript.src]=e},g.prototype.dot2=function(e,t){return this.x*e+this.y*t},g.prototype.dot3=function(e,t,n){return this.x*e+this.y*t+this.z*n};var E=[new g(1,1,0),new g(-1,1,0),new g(1,-1,0),new g(-1,-1,0),new g(1,0,1),new g(-1,0,1),new g(1,0,-1),new g(-1,0,-1),new g(0,1,1),new g(0,-1,1),new g(0,1,-1),new g(0,-1,-1)],k=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],x=new Array(512),b=new Array(512);function T(e){e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(var t=0;t<256;t++){var n;n=1&t?k[t]^255&e:k[t]^e>>8&255,x[t]=x[t+256]=n,b[t]=b[t+256]=E[n%12]}}T(0);var R=.5*(Math.sqrt(3)-1),L=(3-Math.sqrt(3))/6;function S(e,t){var n,r,i=(e+t)*R,a=Math.floor(e+i),o=Math.floor(t+i),s=(a+o)*L,u=e-a+s,c=t-o+s;u>c?(n=1,r=0):(n=0,r=1);var h=u-n+L,l=c-r+L,f=u-1+2*L,d=c-1+2*L,p=b[(a&=255)+x[o&=255]],v=b[a+n+x[o+r]],y=b[a+1+x[o+1]],m=.5-u*u-c*c,w=.5-h*h-l*l,g=.5-f*f-d*d;return 70*((m<0?0:(m*=m)*m*p.dot2(u,c))+(w<0?0:(w*=w)*w*v.dot2(h,l))+(g<0?0:(g*=g)*g*y.dot2(f,d)))}var I,A,O=(I=s(o.mark(function e(){return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:Z=document.getElementById("world-canvas"),(Y=Z.getContext("2d")).mozImageSmoothingEnabled=!1,Y.webkitImageSmoothingEnabled=!1,Y.msImageSmoothingEnabled=!1,Y.imageSmoothingEnabled=!1;case 6:case"end":return e.stop()}},e,this)})),function(){return I.apply(this,arguments)}),N=(A=s(o.mark(function e(t){var n,r,i,a,s,u,c,l,f,d,p,v,y,m,g,E,k,x,b,T;return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.tile_theme+"/",r=(t.player_theme||t.tile_theme)+"/",e.next=4,Promise.all([n+"theme.js",r+"theme.js",P+"theme.js"].map(w));case 4:for(i=e.sent,a=h(i,3),s=a[0],u=a[1],c=a[2],l=Object.assign({},_,s),j=l.tile_width,F=l.tile_depth,G=l.block_height,U=l.tile_gap,B=l.tile_gap_z,W=l.noise_amplifier,z=u.player_height||l.player_height,f=!0,d=!1,p=void 0,e.prev=20,v=D[Symbol.iterator]();!(f=(y=v.next()).done);f=!0)m=y.value,u.sprites.hasOwnProperty(m)?H[m]=X(m,u,r):s.sprites.hasOwnProperty(m)?H[m]=X(m,s,n):H[m]=X(m,c,P);e.next=28;break;case 24:e.prev=24,e.t0=e.catch(20),d=!0,p=e.t0;case 28:e.prev=28,e.prev=29,!f&&v.return&&v.return();case 31:if(e.prev=31,!d){e.next=34;break}throw p;case 34:return e.finish(31);case 35:return e.finish(28);case 36:for(g=!0,E=!1,k=void 0,e.prev=39,x=C[Symbol.iterator]();!(g=(b=x.next()).done);g=!0)T=b.value,s.sprites.hasOwnProperty(T)?H[T]=X(T,s,n):H[T]=X(T,c,P);e.next=47;break;case 43:e.prev=43,e.t1=e.catch(39),E=!0,k=e.t1;case 47:e.prev=47,e.prev=48,!g&&x.return&&x.return();case 50:if(e.prev=50,!E){e.next=53;break}throw k;case 53:return e.finish(50);case 54:return e.finish(47);case 55:return e.abrupt("return",Promise.all(Object.values(H).map(function(e){return e.load()})));case 56:case"end":return e.stop()}},e,this,[[20,24,28,36],[29,,31,35],[39,43,47,55],[48,,50,54]])})),function(e){return A.apply(this,arguments)}),P="img/simple/",_={tile_width:64,tile_depth:32,block_height:16,player_height:128,tile_gap:2,tile_gap_z:1,noise_amplifier:1},M=["south","east","north","west"],D=M.map(function(e){return"player_"+e}),C=["floor","block","mark","cuboid"],H={},q=Object.create(null),j=void 0,F=void 0,G=void 0,U=void 0,B=void 0,W=void 0,z=void 0,Z=void 0,Y=void 0,K=!0,J=!0;function Q(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];K=e}function V(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];J=e}function X(e,t,n){var r=void 0,i=void 0;try{var a=l(t.images[t.sprites[e]]);r=a[0],i=a.slice(1)}catch(t){return void console.warn("Bad theme config: No image for sprite '"+e+"' in "+n)}return i.length?new(Function.prototype.bind.apply(ee,[null].concat([n+r],f(i)))):new $(n+r)}var $=function(){function e(t){u(this,e),this.imagePath=t}return c(e,[{key:"load",value:function(){var e=s(o.mark(function e(){var t;return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,te(this.imagePath);case 2:this._image=e.sent,t=j/this._image.width,this._scaledWidth=j,this._scaledHeight=t*this._image.height,this.height=this._scaledHeight-F;case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"draw",value:function(e,t,n){e.drawImage(this._image,t,n-this.height,this._scaledWidth,this._scaledHeight)}}]),e}(),ee=function(){function e(t,n,r,i,a){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;u(this,e),this.imagePath=t,this._crop={x:n,y:r,width:i,height:a};var c=j/i;this._scaledWidth=j,this._scaledHeight=c*a,this.height=this._scaledHeight-F,this.xOffset=o,this.yOffset=s}return c(e,[{key:"load",value:function(){var e=s(o.mark(function e(){return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,te(this.imagePath);case 2:this._image=e.sent;case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"draw",value:function(e,t,n){e.drawImage(this._image,this._crop.x,this._crop.y,this._crop.width,this._crop.height,t+this.xOffset,n-this.height-this.yOffset,this._scaledWidth,this._scaledHeight)}}]),e}();function te(e){return e in q?q[e]:q[e]=new Promise(function(t){var n=new Image;n.onload=function(){t(n)},n.src=e})}var ne="NOT",re="IF",ie="WHILE",ae=Object.freeze({IDENTIFIER:"IDENTIFIER",INTEGER:"INTEGER",NOT:ne,IF:re,THEN:"THEN",ELSE:"ELSE",WHILE:ie,DO:"DO",REPEAT:"REPEAT",TIMES:"TIMES",PROGRAM:"PROGRAM",ROUTINE:"ROUTINE",LPAREN:"LPAREN",RPAREN:"RPAREN",DOT:"DOT",ASTERISC:"ASTERISC",WHITESPACE:"WHITESPACE",EOF:"EOF"}),oe=function(){function e(t,n,r,i){u(this,e),this.type=t,this.value=n,this.line=r,this.column=i}return c(e,[{key:"toString",value:function(){return this.type+"("+this.value+")"}}]),e}(),se={wenn:re,if:re,dann:"THEN",then:"THEN",sonst:"ELSE",else:"ELSE",solange:ie,while:ie,tue:"DO",do:"DO",nicht:ne,not:ne,wiederhole:"REPEAT",repeat:"REPEAT",mal:"TIMES",times:"TIMES",programm:"PROGRAM",program:"PROGRAM",anweisung:"ROUTINE",routine:"ROUTINE"},ue=Object.keys(se),ce={"(":"LPAREN",")":"RPAREN",".":"DOT","*":"ASTERISC"},he=Object.keys(ce),le=/\s/,fe=/[0-9]/,de=/[A-Za-z_]/i,pe=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];u(this,e),this.text=t,this.includeWhitespace=n,this.position=0,this.line=1,this.column=1}return c(e,[{key:Symbol.iterator,value:function(){return this}},{key:"next",value:function(){var e=this.nextToken();return"EOF"===e.type?{done:!0}:{value:e,done:!1}}},{key:"nextToken",value:function(){for(var e="";this.position<this.text.length&&le.test(this.text[this.position]);)e+=this.text[this.position],"\n"===this.text[this.position]&&(this.column=0,this.line++),this.position++,this.column++;if(e.length&&this.includeWhitespace)return new oe("WHITESPACE",e,this.line,this.column);var t=this.text[this.position];if(he.includes(t))return this.position++,this.column++,new oe(ce[t],t,this.line,this.column);for(var n="";this.position<this.text.length&&fe.test(this.text[this.position]);)n+=this.text[this.position],this.position++,this.column++;if(n.length)return new oe("INTEGER",+n,this.line,this.column);for(var r="";this.position<this.text.length&&de.test(this.text[this.position]);)r+=this.text[this.position],this.position++,this.column++;if(r.length){var i=r.toLowerCase();return ue.includes(i)?new oe(se[i],r,this.line,this.column):new oe("IDENTIFIER",r,this.line,this.column)}if(this.position>=this.text.length)return new oe("EOF","",this.line,this.column);throw new Error("Syntax Error: Could not read next token in line "+this.line+" column "+this.column+".")}},{key:"remainingText",get:function(){return this.text.slice(this.position)}}]),e}(),ve=function(){function e(t){u(this,e),this.tokens=t,this.depth=0,this.forward()}return c(e,[{key:"forward",value:function(){this.currentToken=this.tokens.nextToken()}},{key:"eat",value:function(e){if(this.currentToken.type!==e)throw new Error("Syntax Error on line "+this.tokens.line+": Unexpected token "+this.currentToken+", was expecting "+e+".");this.forward()}},{key:"readToken",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];if(t.includes(this.currentToken.type)){var r=this.currentToken.value;return this.forward(),r}throw new Error("Syntax Error on line "+this.tokens.line+": Unexpected token "+this.currentToken+". Expected any of "+t)}},{key:"readExpression",value:function(){switch(this.currentToken.type){case"IDENTIFIER":return this.readCall();case"INTEGER":var e=+this.currentToken.value;return this.forward(),{type:"INTEGER",value:e};case ne:return this.forward(),{type:ne,expression:this.readExpression()};case"LPAREN":var t=this.readExpression();return this.eat("RPAREN"),t}}},{key:"readCall",value:function(){var e={type:"IDENTIFIER",identifier:this.currentToken.value,line:this.currentToken.line};return this.forward(),"LPAREN"===this.currentToken.type&&(this.forward(),"RPAREN"===this.currentToken.type?this.forward():(e.argument=this.readExpression(),this.eat("RPAREN"))),e}},{key:"readSequence",value:function(){var e=[],t=["ASTERISC","ELSE","EOF"];for(this.depth++;!t.includes(this.currentToken.type);)e.push(this.readStatement());return this.depth--,e}},{key:"readStatement",value:function(){var e={type:this.currentToken.type};switch(this.currentToken.type){case"IDENTIFIER":return this.readCall();case re:return this.forward(),e.condition=this.readExpression(),this.eat("THEN"),e.sequence=this.readSequence(),"ELSE"===this.currentToken.type&&(this.forward(),e.alternative=this.readSequence()),this.eat("ASTERISC"),this.eat(re),e;case ie:return this.forward(),e.condition=this.readExpression(),this.eat("DO"),e.sequence=this.readSequence(),this.eat("ASTERISC"),this.eat(ie),e;case"REPEAT":return this.forward(),this.currentToken.type===ie?(e.type=ie,this.forward(),e.condition=this.readExpression()):(e.count=this.readExpression(),this.eat("TIMES")),e.sequence=this.readSequence(),this.eat("ASTERISC"),this.eat("REPEAT"),e;case"PROGRAM":if(this.depth>1)throw new Error("Parse Error on line "+this.tokens.line+": Can't define program in nested context.");return this.forward(),e.sequence=this.readSequence(),this.eat("ASTERISC"),this.eat("PROGRAM"),e;case"ROUTINE":if(this.depth>1)throw new Error("Parse Error on line "+this.tokens.line+": Can't define routine in nested context.");return this.forward(),e.identifier=this.readToken("IDENTIFIER"),e.sequence=this.readSequence(),this.eat("ASTERISC"),this.eat("ROUTINE"),e}throw new Error("Parse Error on line "+this.tokens.line+": Unexpected token "+this.currentToken+".")}}]),e}(),ye=function(){function e(t){u(this,e),this.runtime=t,this.routines=Object.create(null)}return c(e,[{key:"interrupt",value:function(){this._interrupted=!0}},{key:"run",value:function(){var e=s(o.mark(function e(t){var n,r,i;return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new pe(t),r=new ve(n),i=r.readSequence(),this._interrupted=!1,e.next=6,this.visitSequence(i);case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"visitSequence",value:function(){var e=s(o.mark(function e(t){var n,r,i,a,s,u;return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,r=!1,i=void 0,e.prev=3,a=t[Symbol.iterator]();case 5:if(n=(s=a.next()).done){e.next=12;break}return u=s.value,e.next=9,this.visitStatement(u);case 9:n=!0,e.next=5;break;case 12:e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),r=!0,i=e.t0;case 18:e.prev=18,e.prev=19,!n&&a.return&&a.return();case 21:if(e.prev=21,!r){e.next=24;break}throw i;case 24:return e.finish(21);case 25:return e.finish(18);case 26:case"end":return e.stop()}},e,this,[[3,14,18,26],[19,,21,25]])}));return function(t){return e.apply(this,arguments)}}()},{key:"visitStatement",value:function(){var e=s(o.mark(function e(t){var n,r;return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.type,e.next="IDENTIFIER"===e.t0?3:e.t0===re?15:e.t0===ie?26:"REPEAT"===e.t0?34:"PROGRAM"===e.t0?45:"ROUTINE"===e.t0?48:50;break;case 3:if(!this._interrupted){e.next=5;break}return e.abrupt("return");case 5:if(!(t.identifier in this.routines)){e.next=12;break}if(!(this.depth>10)){e.next=8;break}throw new Error("RunTime Error: Maximum recursion depth (10) exceeded.");case 8:return e.next=10,this.visitSequence(this.routines[t.identifier]);case 10:e.next=14;break;case 12:return e.next=14,this.runtime.execute(t.identifier,!1,t.line);case 14:return e.abrupt("break",51);case 15:return e.next=17,this.visitExpression(t.condition);case 17:if(!e.sent){e.next=22;break}return e.next=20,this.visitSequence(t.sequence);case 20:e.next=25;break;case 22:if(!t.alternative){e.next=25;break}return e.next=25,this.visitSequence(t.alternative);case 25:return e.abrupt("break",51);case 26:return e.next=28,this.visitExpression(t.condition);case 28:if(!e.sent){e.next=33;break}return e.next=31,this.visitSequence(t.sequence);case 31:e.next=26;break;case 33:return e.abrupt("break",51);case 34:return e.next=36,this.visitExpression(t.count);case 36:n=e.sent,r=0;case 38:if(!(r<n)){e.next=44;break}return e.next=41,this.visitSequence(t.sequence);case 41:r++,e.next=38;break;case 44:return e.abrupt("break",51);case 45:return e.next=47,this.visitSequence(t.sequence);case 47:return e.abrupt("break",51);case 48:return this.routines[t.identifier]=t.sequence,e.abrupt("break",51);case 50:throw new Error("Unimplemented statement type "+t.type);case 51:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"visitExpression",value:function(){var e=s(o.mark(function e(t){return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.type,e.next="INTEGER"===e.t0?3:"IDENTIFIER"===e.t0?4:e.t0===ne?5:8;break;case 3:return e.abrupt("return",+t.value);case 4:return e.abrupt("return",this.runtime.evaluate(t.identifier));case 5:return e.next=7,this.visitExpression(t.expression);case 7:return e.abrupt("return",!e.sent);case 8:throw new Error("Unimplemented expression type");case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}(),me=Object.create(null);me[ae.IDENTIFIER]="identifier",me[ae.INTEGER]="number",[ae.NOT,ae.IF,ae.THEN,ae.ELSE,ae.WHILE,ae.DO,ae.REPEAT,ae.TIMES,ae.PROGRAM,ae.ROUTINE].forEach(function(e){return me[e]="keyword"}),[ae.LPAREN,ae.RPAREN,ae.DOT,ae.ASTERISC].forEach(function(e){return me[e]="punctuation"});var we=new(function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"    ";u(this,e),this.indentation=r,this.unindenRegex=new RegExp("^"+r.split("").join("?")+"?","gm"),this.scrollbox=t.getElementsByClassName("editor-scrollbox")[0],this.highlighted=t.getElementsByClassName("editor-highlight")[0];var i=this.textarea=t.getElementsByClassName("editor-textarea")[0],a=this.caretLayer=t.getElementsByClassName("editor-caret-layer")[0];this.beforeCaret=a.appendChild(document.createElement("span")),this.caret=a.appendChild(document.createElement("span")),this.caret.classList.add("editor-caret"),this.selection=a.appendChild(document.createElement("span")),this.selection.classList.add("editor-selection"),i.addEventListener("keydown",function(e){"Tab"!==e.key&&9!==e.keyCode||(e.preventDefault(),e.shiftKey?n.unindent():n.indent())}),i.addEventListener("input",this.update.bind(this));var o=this.updateCaret.bind(this),s=function(){return setTimeout(o,0)};i.addEventListener("keypress",s),i.addEventListener("keydown",s),i.addEventListener("mousedown",function(){this.addEventListener("mousemove",s),s()}),i.addEventListener("mouseup",function(){this.removeEventListener("mousemove",s),s()}),this.update()}return c(e,[{key:"update",value:function(){this.highlighted.innerHTML=function(e){var t="",n=1,r=function(){return'</span></span><span class="line"><span class="lineno">'+ ++n+"</span><span>"},i=new pe(e,!0);try{var a=!0,o=!1,s=void 0;try{for(var u,c=i[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var h=u.value;h.type in me?t+='<span class="token '+me[h.type]+'">'+h.value+"</span>":t+=h.value.replace(/ /g,"·").replace(/\n/g,r)}}catch(e){o=!0,s=e}finally{try{!a&&c.return&&c.return()}finally{if(o)throw s}}}catch(e){t+=i.remainingText.replace(/\n/g,r)}return'<span class="line"><span class="lineno">1</span><span>'+t+"</span></span>"}(this.textarea.value),this.textarea.style.height=this.highlighted.offsetHeight+"px",this.updateCaret()}},{key:"updateCaret",value:function(){var e=this,t=this.textarea,n=t.value,r=t.selectionDirection,i=t.selectionEnd,a=t.selectionStart;this.beforeCaret.innerHTML=n.slice(0,a),this.selection.innerHTML=n.slice(a,i),this.caret.insertAdjacentElement("forward"===r?"beforebegin":"afterend",this.selection),this.caret.classList.remove("blink"),requestAnimationFrame(function(){return e.caret.classList.add("blink")})}},{key:"markLine",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,a=this.highlighted.getElementsByClassName("current")[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value.classList.remove("current")}}catch(e){n=!0,r=e}finally{try{!t&&a.return&&a.return()}finally{if(n)throw r}}this.highlighted.children[e-1].classList.add("current")}},{key:"indent",value:function(){var e=this.textarea,t=e.value,n=e.selectionStart,r=e.selectionEnd,i=e.selectionDirection;if(t.slice(n,r).includes("\n")){var a=t.lastIndexOf("\n",n-1)+1,o=t.indexOf("\n",r);o<0&&(o=t.length);var s=t.slice(a,o).replace(/^/gm,this.indentation);this.textarea.value=t.slice(0,a)+s+t.slice(o),this.textarea.selectionStart=n+this.indentation.length,this.textarea.selectionEnd=a+s.length-(o-r),this.textarea.selectionDirection=i}else{var u=this.indentation;if("\t"!==u){var c=t.lastIndexOf("\n",n)+1,h=u.length-(n-c)%u.length;u=u.substr(0,h)}this.textarea.value=t.slice(0,n)+u+t.slice(r),this.textarea.selectionStart=this.textarea.selectionEnd=n+u.length}this.update()}},{key:"unindent",value:function(){var e=this.textarea,t=e.value,n=e.selectionStart,r=e.selectionEnd,i=e.selectionDirection,a=t.lastIndexOf("\n",n-1)+1,o=t.indexOf("\n",r);o<0&&(o=t.length);var s=null,u=t.slice(a,o).replace(this.unindenRegex,function(e){return null===s&&(s=e.length),""});this.textarea.value=t.slice(0,a)+u+t.slice(o),this.textarea.selectionStart=Math.max(a,n-s),this.textarea.selectionEnd=Math.max(a+u.lastIndexOf("\n")+1,r-o+a+u.length),this.textarea.selectionDirection=i,this.update()}},{key:"value",get:function(){return this.textarea.value},set:function(e){this.textarea.value=e,this.update()}}]),e}())(p("editor")[0]),ge=function(){var e=s(o.mark(function e(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Re){e.next=3;break}return e.next=3,Le;case 3:if(null!==r&&we.markLine(r),Ce(t),Ne(),!Te||n){e.next=9;break}return e.next=9,Ae(be);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),Ee={linksdrehen:"turnLeft",rechtsdrehen:"turnRight",schritt:"step","schrittzurück":"stepBackwards",hinlegen:"placeBlock",aufheben:"takeBlock",markesetzen:"placeMark","markelöschen":"takeMark",istwand:"isLookingAtEdge"},ke=new ye({execute:ge,evaluate:Ce}),xe=void 0,be=100,Te=!0,Re=!0,Le=Promise.resolve(),Se=function(){},Ie=void 0,Ae=function(e){return new Promise(function(t){Ie=t,setTimeout(t,e)})};function Oe(e){xe=e,Ne()}function Ne(){!function(e){var t=e.width,n=e.length,r=e.height,i=e.player,a=e.tiles,o=e.seed,s=.5*(t+n)*(j+2*U),u=.5*(t+n)*(F+1*U)+r*G+z;Z.width!==s&&(Z.width=s),Z.height!==u&&(Z.height=u),Y.clearRect(0,0,Z.width,Z.height),J&&T(o);for(var c=.5*(n-1)*(j+2*U),h=void 0,l=void 0,f=void 0,d=0;d<t;++d)for(var p=0;p<n;++p){h=.5*(-p+d)*(j+2*U)+U+c,l=.5*(p+d)*(F+1*U)-.5*U+r*G+z;var v=a[d*n+p];if(f=0,J&&(f+=5*W*S(d/10,p/10)+W*S(d/3,p/3)),H.floor.draw(Y,h,l-f),f+=H.floor.height+B,v.cuboid)H.cuboid.draw(Y,h,l-f),f+=H.cuboid.height+B;else{for(var y=0;y<v.blocks;++y)H.block.draw(Y,h,l-f),f+=H.block.height+B;v.mark&&(H.mark.draw(Y,h,l-f),f+=H.mark.height+B)}K&&i.x===d&&i.y===p&&H["player_"+M[i.orientation]].draw(Y,h,l-f)}}(xe)}function Pe(e){be=e}function _e(){Re&&(Re=!1,Le=new Promise(function(e){return Se=e}))}function Me(){Re=!0,Se()}var De=function(){var e=s(o.mark(function e(){var t;return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!Re){e.next=4;break}Ie(),e.next=11;break;case 4:return t=Te,Te=!1,Me(),e.next=9,Le;case 9:_e(),Te=t;case 11:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}();function Ce(e){var t=Ee[e.toLowerCase()];if(!t)throw new Error("RunTime Error: "+e+" is not defined.");return xe[t]()}var He,qe=(He=s(o.mark(function e(t){return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return Te=!0,Me(),e.next=4,ke.run(t);case 4:case"end":return e.stop()}},e,this)})),function(e){return He.apply(this,arguments)});var je=function(){function e(t,n,r,i,a,o){u(this,e),this.width=t,this.length=n,this.height=r,this.seed=i||y(1<<31,-(1<<31)),this.player=a||{x:0,y:0,orientation:0},this.tiles=o||Array.from({length:t*n},function(){return{blocks:0,mark:!1}})}return c(e,[{key:"contains",value:function(e,t){return e>=0&&t>=0&&e<this.width&&t<this.length}},{key:"isLookingAtEdge",value:function(){return!this.contains.apply(this,f(e.move(this.player)))}},{key:"step",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=this.tiles[this.player.x*this.length+this.player.y].blocks,i=e.move(this.player,t,n),a=h(i,2),o=a[0],s=a[1];if(!this.contains(o,s))throw new Error("invalid move: out of world");var u=this.tiles[o*this.length+s];if(1<Math.abs(r-u.blocks))throw new Error("invalid move: jump too high");if(u.cuboid)throw new Error("invalid move: cuboid");var c=[o,s];this.player.x=c[0],this.player.y=c[1]}},{key:"stepBackwards",value:function(){this.step(-1)}},{key:"turnLeft",value:function(){this.player.orientation=(this.player.orientation+1)%4}},{key:"turnRight",value:function(){this.player.orientation=(this.player.orientation+3)%4}},{key:"placeBlock",value:function(){var t=e.move(this.player),n=h(t,2),r=n[0],i=n[1];if(!this.contains(r,i))throw new Error("invalid action: out of world");var a=this.tiles[r*this.length+i];if(a.cuboid)throw new Error("invalid action: block on cuboid");if(a.blocks>=this.height)throw new Error("invalid action: building too high");a.blocks++}},{key:"takeBlock",value:function(){var t=e.move(this.player),n=h(t,2),r=n[0],i=n[1];if(!this.contains(r,i))throw new Error("invalid action: out of world");var a=this.tiles[r*this.length+i];if(a.blocks<=0)throw new Error("invalid action: no blocks");a.blocks--}},{key:"placeMark",value:function(){var e=this.tiles[this.player.x*this.length+this.player.y];if(e.mark)throw new Error("invalid action: already has a mark");e.mark=!0}},{key:"takeMark",value:function(){var e=this.tiles[this.player.x*this.length+this.player.y];if(!e.mark)throw new Error("invalid action: no mark");e.mark=!1}}],[{key:"move",value:function(e){var t=e.x,n=e.y,r=e.orientation,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;switch(r){case 0:t+=a,n+=i;break;case 1:t+=i,n+=a;break;case 2:t-=a,n-=i;break;case 3:t-=i,n-=a}return[t,n]}}]),e}();function Fe(e){return function(e){return new Promise(function(t){var n=new FileReader;n.onload=function(){t(n.result)},n.readAsText(e)})}(e).then(Ge)}function Ge(e){for(var t=e.split(/\s+/),n=t.slice(1,7).map(function(e){return+e}),r=h(n,6),i=r[0],a=r[1],o=r[2],s=r[3],u=r[4],c=r[5],l=[],f=0;f<i*a;f++){var d=7+(o+1)*f,p=t.slice(d,d+o+1),v={blocks:p.filter(function(e){return"z"===e}).length,mark:"m"===p[p.length-1]};p.includes("q")&&(v.cuboid=!0),l.push(v)}return new je(i,a,o,0,{x:s,y:u,orientation:c},l)}var Ue={ArrowLeft:"LinksDrehen",a:"LinksDrehen",ArrowRight:"RechtsDrehen",d:"RechtsDrehen",ArrowUp:"Schritt",w:"Schritt",ArrowDown:"SchrittZurück",s:"SchrittZurück",h:"Hinlegen",H:"Aufheben",m:"MarkeSetzen",M:"MarkeLöschen"},Be=d("width-input"),We=d("length-input"),ze=d("height-input"),Ze=d("file-input"),Ye=d("world-simulation-speed"),Ke=d("world-show-player"),Je=d("world-show-flat"),Qe=d("status-text");function Ve(e){e&&e.preventDefault(),Oe(new je(+Be.value,+We.value,+ze.value))}function Xe(e){e&&e.preventDefault(),Fe(Ze.files[0]).then(Oe)}function $e(){d("world-create-form").addEventListener("submit",Ve),d("world-load-form").addEventListener("submit",Xe),Ze.addEventListener("change",Xe),Ke.addEventListener("change",function(){Q(Ke.checked),Ne()}),Q(Ke.checked),Je.addEventListener("change",function(){V(!Je.checked),Ne()}),V(!Je.checked),Ye.addEventListener("change",function(){Pe(Math.pow(10,4-Ye.value))}),Pe(Math.pow(10,4-Ye.value));var e,t=!1;addEventListener("keydown",(e=s(o.mark(function e(n){var r;return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n.defaultPrevented||n.target instanceof HTMLTextAreaElement)){e.next=2;break}return e.abrupt("return");case 2:if(!(r=Ue[n.key])){e.next=22;break}if(n.preventDefault(),!t){e.next=7;break}return e.abrupt("return");case 7:return t=!0,e.prev=8,e.next=11,ge(r.toLowerCase(),!0);case 11:Qe.innerHTML="",Qe.classList.remove("status-error"),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(8),Qe.innerHTML=e.t0.message,Qe.classList.add("status-error");case 19:return e.prev=19,t=!1,e.finish(19);case 22:case"end":return e.stop()}},e,this,[[8,15,19,22]])})),function(t){return e.apply(this,arguments)}));var n,r=d("run-button"),i=d("stop-button"),a=d("step-button"),u=d("unpause-button"),c=d("pause-button"),h=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map(function(e){return e.removeAttribute("disabled")})},l=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map(function(e){return e.setAttribute("disabled","disabled")})};l(i),l(a),l(c),l(u),r.addEventListener("click",(n=s(o.mark(function e(t){return o.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.preventDefault(),l(r),h(i,a,c),Qe.innerHTML="",Qe.classList.remove("status-error"),Qe.innerHTML="RUNNING.",e.prev=6,e.next=9,qe(we.value);case 9:e.next=15;break;case 11:e.prev=11,e.t0=e.catch(6),Qe.innerHTML=e.t0.message,Qe.classList.add("status-error");case 15:return e.prev=15,h(r),l(i,a,c,u),e.finish(15);case 19:case"end":return e.stop()}},e,this,[[6,11,15,19]])})),function(e){return n.apply(this,arguments)})),i.addEventListener("click",function(e){e.preventDefault(),Te=!1,ke.interrupt(),Ie(),Qe.innerHTML="STOPPED."}),a.addEventListener("click",function(e){e.preventDefault(),De()}),c.addEventListener("click",function(e){e.preventDefault(),_e(),Qe.innerHTML="PAUSED.",l(c),h(u)}),u.addEventListener("click",function(e){e.preventDefault(),Me(),Qe.innerHTML="RUNNING.",l(u),h(c)}),Ve(),fetch("BOT.kdp").then(function(e){return e.text()}).then(function(e){return we.value=e})}w("config.js").then(function(e){return function(e){return Promise.all([N(e),O()])}(e).then($e)})}();
